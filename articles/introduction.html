<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>counterfactuals R package • counterfactuals</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="counterfactuals R package">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">counterfactuals</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/introduction.html">counterfactuals R package</a>
    </li>
    <li>
      <a href="../articles/how-to-add-new-cf-methods.html">How to extend the package</a>
    </li>
    <li>
      <a href="../articles/other_models.html">Processing models of different packages</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/dandls/counterfactuals/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>counterfactuals R package</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/dandls/counterfactuals/blob/main/vignettes/introduction.Rmd" class="external-link"><code>vignettes/introduction.Rmd</code></a></small>
      <div class="hidden name"><code>introduction.Rmd</code></div>

    </div>

    
    
<p>In the following, we explain the <code>counterfactuals</code>
workflow for both a classification and a regression task using concrete
use cases.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/dandls/counterfactuals" class="external-link">"counterfactuals"</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://giuseppec.github.io/iml/" class="external-link">"iml"</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://www.stat.berkeley.edu/~breiman/RandomForests/" class="external-link">"randomForest"</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://mlr3.mlr-org.com" class="external-link">"mlr3"</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://mlr3learners.mlr-org.com" class="external-link">"mlr3learners"</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="classification-task">Classification Task<a class="anchor" aria-label="anchor" href="#classification-task"></a>
</h3>
<p>To illustrate the <code>counterfactuals</code> workflow for
classification tasks, we search for counterfactuals with
<code>MOC</code> (Dandl et al. 2020) for a bank customer, whose credit
application is rejected.</p>
<div class="section level4">
<h4 id="data-german-credit-dataset">Data: German Credit Dataset<a class="anchor" aria-label="anchor" href="#data-german-credit-dataset"></a>
</h4>
<p>As training data, we use the German Credit Data from the
<code>rchallenge</code> package. The data set contains 1000 observations
with 21 features and the binary target variable
<code>credit_risk</code>. For illustrative purposes, we only consider 8
of the 21 features in the following:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">german</span>, package <span class="op">=</span> <span class="st">"rchallenge"</span><span class="op">)</span>  </span>
<span><span class="va">credit</span> <span class="op">=</span> <span class="va">german</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"duration"</span>, <span class="st">"amount"</span>, <span class="st">"purpose"</span>, <span class="st">"age"</span>, </span>
<span>  <span class="st">"employment_duration"</span>, <span class="st">"housing"</span>, <span class="st">"number_credits"</span>, <span class="st">"credit_risk"</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<table style="width:100%;" class="table">
<thead><tr>
<th style="text-align:left;">
Variable
</th>
<th style="text-align:left;">
Description
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
duration
</td>
<td style="text-align:left;">
Credit duration
</td>
</tr>
<tr>
<td style="text-align:left;">
amount
</td>
<td style="text-align:left;">
Credit amount (DM)
</td>
</tr>
<tr>
<td style="text-align:left;">
purpose
</td>
<td style="text-align:left;">
Purpose of credit
</td>
</tr>
<tr>
<td style="text-align:left;">
age
</td>
<td style="text-align:left;">
Age (years)
</td>
</tr>
<tr>
<td style="text-align:left;">
savings
</td>
<td style="text-align:left;">
Amount in savings account
</td>
</tr>
<tr>
<td style="text-align:left;">
employment_duration
</td>
<td style="text-align:left;">
Years in present employment
</td>
</tr>
<tr>
<td style="text-align:left;">
housing
</td>
<td style="text-align:left;">
Type of housing
</td>
</tr>
<tr>
<td style="text-align:left;">
number_credits
</td>
<td style="text-align:left;">
Number of credits
</td>
</tr>
<tr>
<td style="text-align:left;">
credit_risk
</td>
<td style="text-align:left;">
Class variable (credit worthiness)
</td>
</tr>
</tbody>
</table>
</div>
<div class="section level4">
<h4 id="fitting-a-model">Fitting a model<a class="anchor" aria-label="anchor" href="#fitting-a-model"></a>
</h4>
<p>First, we train a model to predict whether a credit is
<code>good</code> or <code>bad</code>, omitting one observation from the
training data, which is <code>x_interest</code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">20210816</span><span class="op">)</span></span>
<span><span class="va">rf</span> <span class="op">=</span> <span class="fu">randomForest</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/randomForest/man/randomForest.html" class="external-link">randomForest</a></span><span class="op">(</span><span class="va">credit_risk</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">credit</span><span class="op">[</span><span class="op">-</span><span class="fl">998L</span>,<span class="op">]</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="setting-up-an-imlpredictor-object">Setting up an iml::Predictor() object<a class="anchor" aria-label="anchor" href="#setting-up-an-imlpredictor-object"></a>
</h4>
<p>An <a href="https://giuseppec.github.io/iml/reference/Predictor.html" class="external-link"><code>iml::Predictor</code></a>
object serves as a wrapper for different model types. It contains the
model and the data for its analysis.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">predictor</span> <span class="op">=</span> <span class="fu">iml</span><span class="fu">::</span><span class="va"><a href="https://giuseppec.github.io/iml/reference/Predictor.html" class="external-link">Predictor</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">rf</span>, type <span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span></span>
<span><span class="va">x_interest</span> <span class="op">=</span> <span class="va">credit</span><span class="op">[</span><span class="fl">998L</span>, <span class="op">]</span></span>
<span><span class="va">predictor</span><span class="op">$</span><span class="fu">predict</span><span class="op">(</span><span class="va">x_interest</span><span class="op">)</span></span>
<span><span class="co">#&gt;     bad  good</span></span>
<span><span class="co">#&gt; 1 0.618 0.382</span></span></code></pre></div>
<p>For <code>x_interest</code>, the model predicts a probability of
being a bad credit risk of 0.38.</p>
</div>
<div class="section level4">
<h4 id="find-counterfactuals">Find counterfactuals<a class="anchor" aria-label="anchor" href="#find-counterfactuals"></a>
</h4>
<p>Now, we examine which factors need to be changed to incrase the
predicted probability of being a good credit risk to more than
60%.<br>
Since we want to apply MOC to a classification model, we initialize a
<code>MOCClassif</code> object. Individuals whose prediction is farther
away from the desired prediction than <code>epsilon</code> can be
penalized. Here, we set <code>epsilon = 0</code>, penalizing all
individuals whose prediction is outside the desired interval. With the
<code>fixed_features</code> argument, we can fix non-actionable
features, here <code>age</code> and
<code>employment_duration</code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">moc_classif</span> <span class="op">=</span> <span class="va"><a href="../reference/MOCClassif.html">MOCClassif</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  <span class="va">predictor</span>, epsilon <span class="op">=</span> <span class="fl">0</span>, fixed_features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"age"</span>, <span class="st">"employment_duration"</span><span class="op">)</span>, </span>
<span>  quiet <span class="op">=</span> <span class="cn">TRUE</span>, termination_crit <span class="op">=</span> <span class="st">"genstag"</span>, n_generations <span class="op">=</span> <span class="fl">10L</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Then, we use the <code>find_counterfactuals()</code> method to find
counterfactuals for <code>x_interest</code>. As we aim to find
counterfactuals with a predicted probability of being a good credit risk
of at least 60%, we set the <code>desired_class</code> to
<code>"good"</code> and the <code>desired_prob</code> to
<code>c(0.6, 1)</code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cfactuals</span> <span class="op">=</span> <span class="va">moc_classif</span><span class="op">$</span><span class="fu">find_counterfactuals</span><span class="op">(</span></span>
<span>  <span class="va">x_interest</span>, desired_class <span class="op">=</span> <span class="st">"good"</span>, desired_prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.6</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="the-counterfactuals-object">The counterfactuals object<a class="anchor" aria-label="anchor" href="#the-counterfactuals-object"></a>
</h4>
<p>The resulting <code>Counterfactuals</code> object holds the
counterfactuals in the <code>data</code> field and possesses several
methods for their evaluation and visualization. Printing a
<code>Counterfactuals</code> object, gives an overview of the
results.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">cfactuals</span><span class="op">)</span></span>
<span><span class="co">#&gt; 53 Counterfactual(s) </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Desired class: good </span></span>
<span><span class="co">#&gt; Desired predicted probability range: [0.6, 1] </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Head: </span></span>
<span><span class="co">#&gt;    duration amount purpose   age employment_duration housing number_credits</span></span>
<span><span class="co">#&gt;       &lt;int&gt;  &lt;int&gt;  &lt;fctr&gt; &lt;int&gt;              &lt;fctr&gt;  &lt;fctr&gt;          &lt;ord&gt;</span></span>
<span><span class="co">#&gt; 1:       21   7460  others    30            &gt;= 7 yrs     own              1</span></span>
<span><span class="co">#&gt; 2:       21   7054  others    30            &gt;= 7 yrs     own              1</span></span>
<span><span class="co">#&gt; 3:       21   6435  others    30            &gt;= 7 yrs     own              1</span></span></code></pre></div>
<p>The <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code> method returns the predictions for the
counterfactuals.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">cfactuals</span><span class="op">$</span><span class="fu">predict</span><span class="op">(</span><span class="op">)</span>, <span class="fl">3L</span><span class="op">)</span></span>
<span><span class="co">#&gt;     bad  good</span></span>
<span><span class="co">#&gt; 1 0.322 0.678</span></span>
<span><span class="co">#&gt; 2 0.318 0.682</span></span>
<span><span class="co">#&gt; 3 0.296 0.704</span></span></code></pre></div>
<p>The <code>evaluate()</code> method returns the counterfactuals along
with the evaluation measures <code>dist_x_interest</code>,
<code>dist_target</code>, <code>no_changed</code>, and
<code>dist_train</code>.<br>
Setting the <code>show_diff</code> argument to <code>TRUE</code>
displays the counterfactuals as their difference to
<code>x_interest</code>: for a numeric feature, positive values indicate
an increase compared to the feature value in <code>x_interest</code> and
negative values indicate a decrease; for factors, the counterfactual
feature value is displayed if it differs from <code>x_interest.</code>;
<code>NA</code> means “no difference” in both cases.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">cfactuals</span><span class="op">$</span><span class="fu">evaluate</span><span class="op">(</span>show_diff <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>  measures <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"dist_x_interest"</span>, <span class="st">"dist_target"</span>, <span class="st">"no_changed"</span>, <span class="st">"dist_train"</span><span class="op">)</span><span class="op">)</span>, <span class="fl">3L</span><span class="op">)</span></span>
<span><span class="co">#&gt;    duration amount purpose   age employment_duration housing number_credits dist_x_interest no_changed dist_train dist_target</span></span>
<span><span class="co">#&gt;       &lt;num&gt;  &lt;num&gt;  &lt;char&gt; &lt;num&gt;              &lt;char&gt;  &lt;char&gt;         &lt;char&gt;           &lt;num&gt;      &lt;int&gt;      &lt;num&gt;       &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:       NA  -5220    &lt;NA&gt;    NA                &lt;NA&gt;    &lt;NA&gt;           &lt;NA&gt;      0.04103193          1 0.04215022           0</span></span>
<span><span class="co">#&gt; 2:       NA  -5626    &lt;NA&gt;    NA                &lt;NA&gt;    &lt;NA&gt;           &lt;NA&gt;      0.04422330          1 0.03895885           0</span></span>
<span><span class="co">#&gt; 3:       NA  -6245    &lt;NA&gt;    NA                &lt;NA&gt;    &lt;NA&gt;           &lt;NA&gt;      0.04908897          1 0.03409318           0</span></span></code></pre></div>
<p>By design, not all counterfactuals generated with MOC have a
prediction equal to the desired prediction. We can use
<code>subset_to_valid()</code> to omit all counterfactuals that do not
achieve the desired prediction. This step can be reverted with
<code>revert_subset_to_valid()</code>.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cfactuals</span><span class="op">$</span><span class="fu">subset_to_valid</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">cfactuals</span><span class="op">$</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 22</span></span></code></pre></div>
<p>The <code>plot_freq_of_feature_changes()</code> method plots the
frequency of feature changes across all remaining counterfactuals.
Setting <code>subset_zero = TRUE</code> removes all unchanged features
from the plot.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cfactuals</span><span class="op">$</span><span class="fu">plot_freq_of_feature_changes</span><span class="op">(</span>subset_zero <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: `label` cannot be a <span style="color: #0000BB;">&lt;ggplot2::element_blank&gt;</span> object.</span></span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-13-1.png" class="r-plt" alt="" width="672"></p>
<p>The parallel plot connects the (scaled) feature values of each
counterfactual and highlights <code>x_interest</code> in blue. We
specify <code>feature_names</code> to order the features according to
their frequency of changes.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cfactuals</span><span class="op">$</span><span class="fu">plot_parallel</span><span class="op">(</span>feature_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span></span>
<span>  <span class="va">cfactuals</span><span class="op">$</span><span class="fu">get_freq_of_feature_changes</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>, digits_min_max <span class="op">=</span> <span class="fl">2L</span><span class="op">)</span></span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-14-1.png" class="r-plt" alt="" width="672"></p>
<p>In the following surface plot, the white dot represents
<code>x_interest</code>. All counterfactuals that differ from
<code>x_interest</code> only in the selected features are displayed as
black dots. The tick marks next to the axes indicate the marginal
distribution of the counterfactuals.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cfactuals</span><span class="op">$</span><span class="fu">plot_surface</span><span class="op">(</span>feature_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"duration"</span>, <span class="st">"amount"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-15-1.png" class="r-plt" alt="" width="672"></p>
</div>
<div class="section level4">
<h4 id="moc-diagnostics">MOC diagnostics<a class="anchor" aria-label="anchor" href="#moc-diagnostics"></a>
</h4>
<p>Additional diagnostic tools for MOC are available as part of the
MOCClassif and MOCRegr class. For example, the hypervolume indicator
(Zitzler and Thiele 1998) given a reference point (that represents the
maximal values of the objectives) could be computed. The evolution of
the hypervolume indicator can be plotted together with the evolution of
mean and minimum objective values using the
<code>plot_statistics()</code> method.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">moc_classif</span><span class="op">$</span><span class="fu">plot_statistics</span><span class="op">(</span>centered_obj <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>[[1]]
<img src="introduction_files/figure-html/unnamed-chunk-16-1.png" class="r-plt" alt="" width="672">
[[2]]
<img src="introduction_files/figure-html/unnamed-chunk-16-2.png" class="r-plt" alt="" width="672">
[[3]]
<img src="introduction_files/figure-html/unnamed-chunk-16-3.png" class="r-plt" alt="" width="672"></p>
<p>Ideally, one would like the mean value of each objective to decrease
over the generations, leading to an increase of the hypervolume. We
could visualize the objective values of the emerging candidates
throughout the generations via the <code>plot_search</code> method for
pairs of objectives.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">moc_classif</span><span class="op">$</span><span class="fu">plot_search</span><span class="op">(</span>objectives <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"dist_train"</span>, <span class="st">"dist_target"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-17-1.png" class="r-plt" alt="" width="672"></p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">moc_classif</span><span class="op">$</span><span class="fu">plot_search</span><span class="op">(</span>objectives <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"dist_x_interest"</span>, <span class="st">"dist_train"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-17-2.png" class="r-plt" alt="" width="672"></p>
</div>
</div>
<div class="section level3">
<h3 id="regression-tasks">Regression Tasks<a class="anchor" aria-label="anchor" href="#regression-tasks"></a>
</h3>
<p>Finding counterfactuals for regression models is analogous to
classification models. In this example, we use <code>NICE</code>
(Brughmans et al. (2002)) to search for counterfactuals for plasma .
Brughmans et al. introduced <code>NICE</code> only for the
classification setting but for this package the method was extended to
also work for regression tasks by allowing prediction functions to
return real-valued outcomes instead of classification scores.</p>
<div class="section level4">
<h4 id="data-plasma-retinol">Data: Plasma Retinol<a class="anchor" aria-label="anchor" href="#data-plasma-retinol"></a>
</h4>
<p>As training data, we use the plasma dataset from the
<code>gamlss.data</code> package. The dataset contains 315 observations
with 13 features and the (continuous) target variable
<code>retplasma</code>, the plasma retinol concentration in ng/ml. The
plasma retinol concentration is interesting because low concentrations
are associated with an increased risk for some types of cancer (Harrell
2022).</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">plasma</span>, package <span class="op">=</span> <span class="st">"gamlss.data"</span><span class="op">)</span></span></code></pre></div>
<table style="width:100%;" class="table">
<thead><tr>
<th style="text-align:left;">
Variable
</th>
<th style="text-align:left;">
Description
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
age
</td>
<td style="text-align:left;">
Age (years)
</td>
</tr>
<tr>
<td style="text-align:left;">
sex
</td>
<td style="text-align:left;">
Sex (1 = male, 2 = female)
</td>
</tr>
<tr>
<td style="text-align:left;">
smokstat
</td>
<td style="text-align:left;">
Smoking status (1 = never, 2 = former, 3 = current smoker)
</td>
</tr>
<tr>
<td style="text-align:left;">
bmi
</td>
<td style="text-align:left;">
Body mass index (weight/(height^2))
</td>
</tr>
<tr>
<td style="text-align:left;">
vituse
</td>
<td style="text-align:left;">
Vitamin use (1 = yes, fairly often, 2 = yes, not often, 3 = no)
</td>
</tr>
<tr>
<td style="text-align:left;">
calories
</td>
<td style="text-align:left;">
Number of calories consumed per day
</td>
</tr>
<tr>
<td style="text-align:left;">
fat
</td>
<td style="text-align:left;">
Grams of fat consumed per day
</td>
</tr>
<tr>
<td style="text-align:left;">
fiber
</td>
<td style="text-align:left;">
Grams of fiber consumed per day
</td>
</tr>
<tr>
<td style="text-align:left;">
alcohol
</td>
<td style="text-align:left;">
Number of alcoholic drinks consumed per week
</td>
</tr>
<tr>
<td style="text-align:left;">
cholesterol
</td>
<td style="text-align:left;">
Cholesterol consumed (mg per day)
</td>
</tr>
<tr>
<td style="text-align:left;">
betadiet
</td>
<td style="text-align:left;">
Dietary beta-carotene consumed (mcg per day)
</td>
</tr>
<tr>
<td style="text-align:left;">
retdiet
</td>
<td style="text-align:left;">
Dietary retinol consumed (mcg per day)
</td>
</tr>
<tr>
<td style="text-align:left;">
betaplasma
</td>
<td style="text-align:left;">
Plasma beta-carotene (ng/ml)
</td>
</tr>
<tr>
<td style="text-align:left;">
retplasma
</td>
<td style="text-align:left;">
Plasma retinol (ng/ml)
</td>
</tr>
</tbody>
</table>
</div>
<div class="section level4">
<h4 id="fitting-a-model-1">Fitting a model<a class="anchor" aria-label="anchor" href="#fitting-a-model-1"></a>
</h4>
<p>First, we train a model to predict <code>plasma_retinol</code>, again
omitting <code>x_interest</code> from the training data. This time we
use a regression tree trained with the <code>mlr3</code> and
<code>rpart</code> package.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tsk</span> <span class="op">=</span> <span class="va"><a href="https://mlr3.mlr-org.com/reference/TaskRegr.html" class="external-link">TaskRegr</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>id <span class="op">=</span> <span class="st">"plasma"</span>, backend <span class="op">=</span> <span class="va">plasma</span><span class="op">[</span><span class="op">-</span><span class="fl">100L</span>,<span class="op">]</span>, </span>
<span>  target <span class="op">=</span> <span class="st">"retplasma"</span><span class="op">)</span></span>
<span><span class="va">tree</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html" class="external-link">lrn</a></span><span class="op">(</span><span class="st">"regr.rpart"</span><span class="op">)</span></span>
<span><span class="va">model</span> <span class="op">=</span> <span class="va">tree</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">tsk</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="setting-up-an-imlpredictor-object-1">Setting up an iml::Predictor() object<a class="anchor" aria-label="anchor" href="#setting-up-an-imlpredictor-object-1"></a>
</h4>
<p>Then, we initialize an <a href="https://giuseppec.github.io/iml/reference/Predictor.html" class="external-link"><code>iml::Predictor</code></a>
object.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">predictor</span> <span class="op">=</span> <span class="fu">iml</span><span class="fu">::</span><span class="va"><a href="https://giuseppec.github.io/iml/reference/Predictor.html" class="external-link">Predictor</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">model</span>, data <span class="op">=</span> <span class="va">plasma</span>, y <span class="op">=</span> <span class="st">"retplasma"</span><span class="op">)</span></span>
<span><span class="va">x_interest</span> <span class="op">=</span> <span class="va">plasma</span><span class="op">[</span><span class="fl">100L</span>, <span class="op">]</span></span>
<span><span class="va">predictor</span><span class="op">$</span><span class="fu">predict</span><span class="op">(</span><span class="va">x_interest</span><span class="op">)</span></span>
<span><span class="co">#&gt;   .prediction</span></span>
<span><span class="co">#&gt; 1    342.9231</span></span></code></pre></div>
<p>For <code>x_interest</code>, the model predicts a plasma
concentration of 342.92.</p>
</div>
<div class="section level4">
<h4 id="find-counterfactuals-1">Find counterfactuals<a class="anchor" aria-label="anchor" href="#find-counterfactuals-1"></a>
</h4>
<p>Since we want to apply <code>NICE</code> to a regression model, we
initialize a <code>NICERegr</code> object. For regression models, we
define a correctly predicted datapoint when its prediction is less than
a user-specified value away. Here we allow for a deviation of
<code>margin_correct = 0.5</code>. In this example, we aim for proximal
counterfactuals in additional to sparse ones, such that we set
<code>optimization = "proximity"</code>.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nice_regr</span> <span class="op">=</span> <span class="va"><a href="../reference/NICERegr.html">NICERegr</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">predictor</span>, optimization <span class="op">=</span> <span class="st">"proximity"</span>, </span>
<span>  margin_correct <span class="op">=</span> <span class="fl">0.5</span>, return_multiple <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>Then, we use the <code>find_counterfactuals()</code> method to find
counterfactuals for <code>x_interest</code> with a predicted plasma
concentration in the interval [500, Inf).</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cfactuals</span> <span class="op">=</span> <span class="va">nice_regr</span><span class="op">$</span><span class="fu">find_counterfactuals</span><span class="op">(</span><span class="va">x_interest</span>, </span>
<span>  desired_outcome <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">500</span>, <span class="cn">Inf</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="the-counterfactuals-object-1">The counterfactuals object<a class="anchor" aria-label="anchor" href="#the-counterfactuals-object-1"></a>
</h4>
<p>As a result, we obtain a <code>Counterfactuals</code> object, just
like for the classification task.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cfactuals</span></span>
<span><span class="co">#&gt; 1 Counterfactual(s) </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Desired outcome range: [500, Inf] </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Head: </span></span>
<span><span class="co">#&gt;      age    sex smokstat      bmi vituse calories   fat fiber alcohol cholesterol betadiet retdiet betaplasma</span></span>
<span><span class="co">#&gt;    &lt;int&gt; &lt;fctr&gt;   &lt;fctr&gt;    &lt;num&gt; &lt;fctr&gt;    &lt;num&gt; &lt;num&gt; &lt;num&gt;   &lt;num&gt;       &lt;num&gt;    &lt;int&gt;   &lt;int&gt;      &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1:    46      1        3 35.25969      3   2667.5 131.6  10.1       0       550.5     1210    1291        218</span></span></code></pre></div>
<p>To inspect the counterfactual, we can use the same tools as before.
For example, in the surface plot, we see that increasing betaplasma
helps while changing the age alone has no impact on the prediction.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cfactuals</span><span class="op">$</span><span class="fu">plot_surface</span><span class="op">(</span>feature_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"betaplasma"</span>, <span class="st">"age"</span><span class="op">)</span>, grid_size <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-25-1.png" class="r-plt" alt="" width="672"></p>
</div>
<div class="section level4">
<h4 id="user-defined-distance-function">User-defined distance function<a class="anchor" aria-label="anchor" href="#user-defined-distance-function"></a>
</h4>
<p>At the beginning, <code>NICE</code> calculates the distance of
<code>x_interest</code> to each of the training samples. By default,
Gower’s distance measures this but users could also specify their own
distance functions in the <code>distance_function</code> argument. For
example, the Gower distance can be replaces by the L_0 norm.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">l0_norm</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">res</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">res</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span> <span class="op">!=</span> <span class="va">y</span><span class="op">[</span><span class="va">j</span>,<span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">res</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>A short example illustrates the functionality of
<code>l0_norm()</code>.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">xt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span>, b <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"a"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">yt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">3.2</span>, <span class="fl">0.1</span><span class="op">)</span>, b <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"a"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">l0_norm</span><span class="op">(</span><span class="va">xt</span>, <span class="va">yt</span>, data <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span><span class="co">#&gt;      [,1] [,2] [,3]</span></span>
<span><span class="co">#&gt; [1,]    0    2    1</span></span></code></pre></div>
<p>Replacing the distance function is fairly easy:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nice_regr</span> <span class="op">=</span> <span class="va"><a href="../reference/NICERegr.html">NICERegr</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">predictor</span>, optimization <span class="op">=</span> <span class="st">"proximity"</span>, </span>
<span>  margin_correct <span class="op">=</span> <span class="fl">0.5</span>, return_multiple <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>  distance_function <span class="op">=</span> <span class="va">l0_norm</span><span class="op">)</span></span>
<span><span class="va">cfactuals</span> <span class="op">=</span> <span class="va">nice_regr</span><span class="op">$</span><span class="fu">find_counterfactuals</span><span class="op">(</span><span class="va">x_interest</span>, </span>
<span>  desired_outcome <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">500</span>, <span class="fl">1000</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cfactuals</span></span>
<span><span class="co">#&gt; 1 Counterfactual(s) </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Desired outcome range: [500, 1000] </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Head: </span></span>
<span><span class="co">#&gt;      age    sex smokstat      bmi vituse calories   fat fiber alcohol cholesterol betadiet retdiet betaplasma</span></span>
<span><span class="co">#&gt;    &lt;int&gt; &lt;fctr&gt;   &lt;fctr&gt;    &lt;num&gt; &lt;fctr&gt;    &lt;num&gt; &lt;num&gt; &lt;num&gt;   &lt;num&gt;       &lt;num&gt;    &lt;int&gt;   &lt;int&gt;      &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1:    46      1        3 35.25969      3   2667.5 131.6  10.1       0       550.5     1210    1291        218</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>Dandl, S., Hofheinz, A., Binder, M., Bischl, B., &amp; Casalicchio,
C. (2025). “counterfactuals: An R Package for Counterfactual Explanation
Methods”. Journal of Statistical Software, 115(9), 1–48. </p>
<p>Dandl, S., Molnar, C., Binder, M., &amp; Bernd Bischl. 2020.
“Multi-Objective Counterfactual Explanations”. In: Parallel Problem
Solving from Nature – PPSN XVI, edited by Thomas Bäck, Mike Preuss,
André Deutz, Hao Wang, Carola Doerr, Michael Emmerich, and Heike
Trautmann, 448–469. Cham: Springer International Publishing. </p>
<p>Brughmans, D., &amp; Martens D. (2022). “NICE: An Algorithm for
Nearest Instance Counterfactual Explanations.” Technical report,
&lt;arXiv:2104.07411&gt; v2</p>
<p>Zitzler, E., &amp; Thiele, L. (1998). “Multiobjective Optimization
Using Evolutionary Algorithms—a Comparative Case Study.” In
International Conference on Parallel Problem Solving from Nature,
292–301. Springer</p>
<p>Harrell, F. E. (2002). “Plasma Retinol and Beta-Carotene Dataset”. <a href="https://hbiostat.org/data/repo/plasma.html" class="external-link uri">https://hbiostat.org/data/repo/plasma.html</a></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Susanne Dandl, Andreas Hofheinz.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

      </footer>
</div>






  </body>
</html>
